<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 線上排班系統 (GitHub/Firebase)</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入 Lucide React 圖示庫 (保持在 Babel 之後，以符合您原始的配置) -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>

    <!-- 載入並公開 Firebase V9 模組 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 將所有需要的 Firebase 模組掛載到 window.firebase 物件上，供 React 腳本使用
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, runTransaction,
            setLogLevel
        };
        // window.firebase.setLogLevel('debug'); // 可在此處啟用 Log 進行除錯
    </script>

    <style>
        /* 列印樣式設定 */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .print\:text-xs { font-size: 10px !important; }
            .print\:bg-gray-100 { background-color: #f3f4f6 !important; }
            .print\:border-gray-300 { border-color: #d1d5db !important; }
            .print-cycle-end { border-right-color: #facc15 !important; border-right-width: 2px !important; }
        }
        /* 確保 body 具有最小高度 */
        #root {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* 從頂部開始對齊 */
            padding: 20px;
            background-color: #f7f7f7;
        }
        
        /* 自定義滾動條樣式 */
        .custom-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body>

    <div id="root">
        <!-- React App 將會渲染在這裡 -->
    </div>

    <script type="text/babel">
        // 確保可以存取 Lucide React 圖示，如果 window.lucide 不存在，則使用空物件避免錯誤
        const lucide = window.lucide || {};
        const { Settings, User, LogOut, Loader, Lock, Unlock, CheckCircle, AlertTriangle } = lucide;

        const { useState, useEffect, useCallback, useMemo } = React;

        // 全域變數定義 (來自 Canvas 環境)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore 路徑計算函數
        const getPrivateCollectionPath = (userId, collectionName) => 
            `/artifacts/${appId}/users/${userId}/${collectionName}`;

        const getPublicCollectionPath = (collectionName) => 
            `/artifacts/${appId}/public/data/${collectionName}`;


        // ==== 應用程式主要邏輯與組件 ====

        // 班表設定
        const SHIFTS = [
            // 早班 (Morning)
            { code: 'A07', name: '早班 (7:00-15:30)', type: 'A', display: 'A07', color: 'text-blue-600', isMorning: true },
            { code: 'B06', name: '早班 (6:00-14:30)', type: 'B', display: 'B06', color: 'text-blue-600', isMorning: true },
            // 晚班 (Evening)
            { code: 'C13', name: '晚班 (13:00-21:30)', type: 'C', display: 'C13', color: 'text-indigo-600', isEvening: true },
            { code: 'D14', name: '晚班 (14:00-22:30)', type: 'D', display: 'D14', color: 'text-indigo-600', isEvening: true },
            // 特殊/休假班 (Special/Leave)
            { code: 'H', name: '國定假日 (Holiday)', type: 'H', display: 'H', color: 'text-red-600' },
            { code: 'R', name: '休息日 (Rest)', type: 'R', display: 'R', color: 'text-red-600' },
            { code: 'O', name: '其他假別 (Other)', type: 'O', display: 'O', color: 'text-red-600' },
            { code: '-', name: '未排班', type: '-', display: '-', color: 'text-gray-400' },
        ];
        
        // 取得所有可點擊切換的班別 (不包含'-')
        const TOGGLE_SHIFTS = SHIFTS.filter(s => s.code !== '-');


        // 日期計算與四週工時邏輯
        const getMonthDates = (year, month) => {
            const dates = [];
            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const date = new Date(d);
                const dayOfWeek = date.getDay(); // 0=Sun, 6=Sat
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // 更精確的週期計算 (假設第一個週期從 1/1 開始，每 28 天結算一次，結算日在週期末)
                const dayOfYear = Math.floor((date - new Date(year, 0, 1)) / (1000 * 60 * 60 * 24)) + 1;
                // 結算日是第 28, 56, 84, ... 天
                const isCycleEnd = (dayOfYear > 0 && dayOfYear % 28 === 0);
                
                // 判斷是否為假日 (六日) 或國定假日
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isNationalHoliday = (month === 2 && date.getDate() === 16); // 假設 2/16 為國定假日
                
                dates.push({
                    date: date,
                    dateStr: dateStr,
                    dayOfWeek: dayOfWeek,
                    isWeekend: isWeekend,
                    isNationalHoliday: isNationalHoliday,
                    isCycleEnd: isCycleEnd,
                    dayDisplay: date.getDate(),
                    weekdayDisplay: ['日', '一', '二', '三', '四', '五', '六'][dayOfWeek]
                });
            }
            return dates;
        };
        
        const initialYear = 2026;
        const initialMonth = 1;

        // 班別規則檢查
        const checkShiftRules = (scheduleData, dateList) => {
            const auditData = {};
            const shiftCodes = SHIFTS.map(s => s.code);
            
            // 班別有效性檢查 (B06 隔天不能排 A07)
            scheduleData.forEach(user => {
                auditData[user.id] = {};
                dateList.forEach((day, index) => {
                    const currentShift = user.schedule?.[day.dateStr] || '-';
                    auditData[user.id][day.dateStr] = {
                        isShiftValid: shiftCodes.includes(currentShift), // 班別字串有效性
                        isRuleValid: true // 班別規則有效性 (B06 -> A07)
                    };

                    // *** 修正後的規則檢查邏輯：B06 隔天不能排 A07 ***
                    if (currentShift === 'B06' && index < dateList.length - 1) {
                        const nextDayStr = dateList[index + 1].dateStr;
                        const nextShift = user.schedule?.[nextDayStr] || '-';
                        if (nextShift === 'A07') {
                            auditData[user.id][day.dateStr].isRuleValid = false; // B06 本身違規
                        }
                    }
                });
            });

            // 人力總結檢查 (每日所需人力)
            const staffAudit = {};
            dateList.forEach(day => {
                let countMorning = 0;
                let countEvening = 0;
                let requiredMorning = 1;
                let requiredEvening = 1;
                
                // 預設 (可能為假日或特殊狀況)
                requiredMorning = 1; 
                requiredEvening = 1;

                if (!day.isWeekend && !day.isNationalHoliday) {
                    // 平日 (非假日且非國定假日)
                    requiredMorning = 2; // 假設平日需 2 早
                    requiredEvening = 2; // 假設平日需 2 晚
                } else if (day.isNationalHoliday) {
                    // 國定假日 (假設 2/16)
                    requiredMorning = 1;
                    requiredEvening = 0; // 2/16 僅需 1 早，0 晚
                } else if (day.isWeekend) {
                    // 一般週末假日 (非國定假日的六日)
                    requiredMorning = 1;
                    requiredEvening = 1;
                }


                scheduleData.forEach(user => {
                    const shiftCode = user.schedule?.[day.dateStr] || '-';
                    const shift = SHIFTS.find(s => s.code === shiftCode);
                    if (shift) {
                        if (shift.isMorning) countMorning++;
                        if (shift.isEvening) countEvening++;
                    }
                });

                const isMorningSufficient = countMorning >= requiredMorning;
                const isEveningSufficient = countEvening >= requiredEvening;
                const isUnderstaffed = !isMorningSufficient || !isEveningSufficient;
                
                staffAudit[day.dateStr] = {
                    morning: countMorning,
                    evening: countEvening,
                    requiredM: requiredMorning,
                    requiredE: requiredEvening,
                    isSufficient: isMorningSufficient && isEveningSufficient,
                    isUnderstaffed: isUnderstaffed
                };
            });
            
            return { shiftAudit: auditData, staffAudit: staffAudit };
        };


        // ==== React 組件 (主應用程式) ====

        
        const App = () => {
            // Firebase States
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [userDisplayName, setUserDisplayName] = useState('訪客');
            const [isAuthReady, setIsAuthReady] = useState(false);
            
            // App States
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [error, setError] = useState(null);
            const [scheduleData, setScheduleData] = useState([]);
            const [month, setMonth] = useState(initialMonth);
            const [year, setYear] = useState(initialYear);

            // 計算日期列表
            const dateList = useMemo(() => getMonthDates(year, month), [year, month]);
            
            // 班表審核結果
            const { shiftAudit, staffAudit } = useMemo(() => 
                checkShiftRules(scheduleData, dateList), 
                [scheduleData, dateList]
            );


            // 1. Firebase 初始化與身份驗證
            useEffect(() => {
                // 檢查 window.firebase 是否已由 head 中的 type="module" 腳本成功掛載
                if (!window.firebase || !window.firebase.initializeApp) {
                    setError("錯誤：Firebase 模組載入失敗。請檢查 head 內部的 type='module' 腳本。");
                    setIsLoading(false);
                    return;
                }
                
                try {
                    // window.firebase.setLogLevel('debug'); // 啟用 FireStore Log 
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const authInstance = window.firebase.getAuth(app);
                    const dbInstance = window.firebase.getFirestore(app);

                    setAuth(authInstance);
                    setDb(dbInstance);

                    // 處理身份驗證
                    const handleAuth = async () => {
                        try {
                            if (initialAuthToken) {
                                await window.firebase.signInWithCustomToken(authInstance, initialAuthToken);
                            } else {
                                await window.firebase.signInAnonymously(authInstance);
                            }
                        } catch (e) {
                            console.error("Firebase 登入失敗:", e);
                        }

                        // 無論登入成功或失敗，都開始監聽 Auth 狀態
                        const unsubscribe = window.firebase.onAuthStateChanged(authInstance, (user) => {
                            if (user) {
                                setUserId(user.uid);
                                // 嘗試使用 email 或 uid 的前四碼作為預設名稱
                                setUserDisplayName(user.email ? user.email.split('@')[0] : `User_${user.uid.substring(0, 4)}`);
                            } else {
                                // 匿名登入或登出，使用隨機 ID 作為 fallback
                                setUserId(crypto.randomUUID()); 
                            }
                            setIsAuthReady(true);
                            setIsLoading(false);
                        });
                        return unsubscribe;
                    };
                    
                    const unsubscribeAuth = handleAuth();

                    return () => { 
                        // 清理 onAuthStateChanged 監聽器，確保它不是一個 Promise
                        if (unsubscribeAuth && typeof unsubscribeAuth.then !== 'function') unsubscribeAuth(); 
                    };
                } catch (e) {
                    console.error("Firebase 初始化失敗:", e);
                    setError(`Firebase 初始化失敗: ${e.message}`);
                    setIsLoading(false);
                }
            }, []);

            // 2. 訂閱排班資料
            useEffect(() => {
                if (!db || !userId || !isAuthReady) return; // 確保 Firebase 和 Auth 都準備好

                const scheduleColPath = getPublicCollectionPath('schedules');
                const q = window.firebase.query(
                    window.firebase.collection(db, scheduleColPath),
                    window.firebase.where('year', '==', year),
                    window.firebase.where('month', '==', month)
                );
                
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const newScheduleData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // 確保目前登入的使用者資料存在，若不存在則建立一個骨架
                    let foundCurrentUser = false;
                    const updatedScheduleData = newScheduleData.map(user => {
                        if (user.id === userId) {
                            foundCurrentUser = true;
                            // 使用 Firestore 中的 displayName (如果存在) 或本地的 userDisplayName
                            const display = user.displayName || userDisplayName;
                            return { ...user, displayName: display, year: year, month: month };
                        }
                        return user;
                    });

                    if (!foundCurrentUser) {
                        updatedScheduleData.push({
                            id: userId,
                            displayName: userDisplayName,
                            year: year,
                            month: month,
                            schedule: {}
                        });
                    }

                    // 排序: 登入者自己的資料放第一位
                    updatedScheduleData.sort((a, b) => {
                        if (a.id === userId) return -1;
                        if (b.id === userId) return 1;
                        return (a.displayName || "").localeCompare(b.displayName || "");
                    });
                    
                    setScheduleData(updatedScheduleData);
                }, (err) => {
                    console.error("訂閱排班資料失敗:", err);
                    // 不設定 error，避免干擾 UI
                });

                return () => unsubscribe(); // 清理 onSnapshot 監聽器
            }, [db, userId, isAuthReady, year, month, userDisplayName]);


            // 3. 處理班別變更
            const handleShiftChange = useCallback(async (scheduleId, dateStr, newShift) => {
                if (!db || !userId || isSaving) return;

                const targetUserSchedule = scheduleData.find(s => s.id === scheduleId);
                if (!targetUserSchedule || scheduleId !== userId) {
                    console.warn("警告: 嘗試編輯非本人的班表。");
                    return; // 僅允許編輯自己的排程
                }
                
                setIsSaving(true);
                
                try {
                    const scheduleColPath = getPublicCollectionPath('schedules');
                    const userDocRef = window.firebase.doc(db, scheduleColPath, scheduleId);

                    await window.firebase.runTransaction(db, async (transaction) => {
                        const userDoc = await transaction.get(userDocRef);
                        const currentSchedule = userDoc.exists() ? userDoc.data().schedule : {};

                        // 判斷是否為「取消」操作 (點擊相同班別或設為 '-')
                        const isCurrentShift = newShift === targetUserSchedule.schedule?.[dateStr];
                        
                        let shiftToSet;
                        if (isCurrentShift) {
                            // 點擊相同班別 -> 移除 (設為 '-')
                            shiftToSet = '-';
                        } else {
                            // 點擊不同班別 -> 更新
                            shiftToSet = newShift;
                        }
                        
                        if (shiftToSet === '-') {
                            // 移除該天的班別
                            delete currentSchedule[dateStr];
                        } else {
                            // 設定班別
                            currentSchedule[dateStr] = shiftToSet;
                        }

                        // 處理文件更新或新增
                        const dataToSave = {
                            id: userId,
                            displayName: userDisplayName,
                            year: year,
                            month: month,
                            schedule: currentSchedule
                        };

                        if (userDoc.exists()) {
                            // 文件存在，使用 update
                            transaction.update(userDocRef, dataToSave);
                        } else {
                            // 文件不存在，使用 set
                            transaction.set(userDocRef, dataToSave);
                        }
                    });

                } catch (e) {
                    console.error("更新班別失敗:", e);
                    setError(`更新班別失敗: ${e.message}`);
                } finally {
                    setIsSaving(false);
                }
            }, [db, userId, isSaving, scheduleData, userDisplayName, year, month]);

            
            // 4. UI/元件定義
            
            const ShiftCell = ({ shiftCode, isEditable, dateStr, scheduleId, isValid }) => {
                const shift = SHIFTS.find(s => s.code === shiftCode);
                const display = shift ? shift.display : shiftCode;
                const isHolidayOrRest = ['H', 'R', 'O'].includes(shiftCode);
                
                const currentIndex = TOGGLE_SHIFTS.findIndex(s => s.code === shiftCode);
                
                const handleClick = (e) => {
                    e.stopPropagation();
                    if (!isEditable || isSaving) return;

                    let nextIndex = currentIndex;
                    let nextShiftCode = shiftCode;

                    // 循環切換到下一個班別 (在 TOGGLE_SHIFTS 範圍內)
                    if (currentIndex === -1) {
                         // 如果當前是 '-', 則從第一個可切換的班別開始 (A07)
                        nextShiftCode = TOGGLE_SHIFTS[0].code; 
                    } else {
                         // 切換到 TOGGLE_SHIFTS 中的下一個
                        nextIndex = (currentIndex + 1) % TOGGLE_SHIFTS.length;
                        nextShiftCode = TOGGLE_SHIFTS[nextIndex].code;
                    }
                    
                    // 如果點擊後的新班別與當前班別相同，則會被 handleShiftChange 設為 '-'
                    handleShiftChange(scheduleId, dateStr, nextShiftCode);
                };

                const Icon = Settings || 'div'; // Fallback

                return (
                    <button
                        onClick={handleClick}
                        className={`w-full h-full p-1 text-xs font-semibold rounded-md transition-all duration-100 
                            ${isEditable && !isSaving ? 'cursor-pointer hover:bg-gray-200' : 'cursor-default'} 
                            ${isHolidayOrRest ? 'text-red-600 font-bold' : shift ? shift.color : 'text-gray-400'}
                            ${isValid === false ? 'bg-red-100/70 border border-red-500' : ''}
                        `}
                        disabled={isSaving || !isEditable}
                        title={shift?.name || '班別'}
                    >
                        {display}
                    </button>
                );
            };
            

            const ScheduleTable = () => {
                // 使用 Fallback 處理圖示元件不存在的情況
                const LoaderIcon = Loader || 'div';
                const UserIcon = User || 'div';
                const LockIcon = Lock || 'div';
                const SettingsIcon = Settings || 'div';


                return (
                    <div className="max-w-full overflow-x-auto custom-scroll shadow-xl rounded-lg bg-white p-2 relative">
                        {isSaving && (
                            <div className="absolute inset-0 bg-white/70 flex items-center justify-center z-20 rounded-lg">
                                <LoaderIcon className="w-10 h-10 text-blue-500 animate-spin" />
                                <span className="ml-3 text-lg text-gray-700">正在儲存...</span>
                            </div>
                        )}
                        <table className="min-w-full divide-y divide-gray-300 border-collapse">
                            <thead>
                                {/* 日期標頭 (星期、日期) */}
                                <tr className="bg-gray-50 sticky top-0 z-10">
                                    <th className="sticky left-0 bg-gray-100 text-center text-sm font-semibold text-gray-700 py-2 px-3 border-r border-b border-gray-300 w-24 min-w-[96px] shadow-sm">
                                        姓名/日期
                                    </th>
                                    {dateList.map((day, index) => (
                                        <th 
                                            key={index}
                                            className={`text-center py-2 px-1 border-r border-b border-gray-300 text-xs 
                                                ${day.isWeekend || day.isNationalHoliday ? 'bg-red-50/50 text-red-600' : 'text-gray-600'}
                                                ${day.isCycleEnd ? 'border-r-yellow-400 border-r-2 print-cycle-end' : ''}
                                            `}
                                        >
                                            <div className="flex flex-col font-medium">
                                                <span>{day.weekdayDisplay}</span>
                                                <span className="text-sm font-bold">{day.dayDisplay}</span>
                                            </div>
                                        </th>
                                    ))}
                                    <th className="sticky right-0 bg-gray-100 text-center text-sm font-semibold text-gray-700 py-2 px-3 border-l border-b border-gray-300 w-24 min-w-[96px] shadow-sm">
                                        週期總結
                                    </th>
                                </tr>
                                {/* 人力總結標頭 */}
                                <tr>
                                    <th className="sticky left-0 bg-gray-200 text-center text-xs font-semibold text-gray-700 py-1 px-3 border-r border-b border-gray-300 w-24 min-w-[96px] shadow-sm">
                                        人力總結
                                    </th>
                                    {dateList.map((day, index) => {
                                        const audit = staffAudit[day.dateStr];
                                        const isUnderstaffed = audit ? audit.isUnderstaffed : false;
                                        const morningText = `${audit.morning} (需${audit.requiredM})`;
                                        const eveningText = `${audit.evening} (需${audit.requiredE})`;

                                        return (
                                            <th 
                                                key={index}
                                                className={`text-center py-1 border-r border-b border-gray-300 text-[10px] font-bold 
                                                    ${isUnderstaffed ? 'bg-red-200/50 text-red-700' : 'bg-green-50/50 text-green-700'}
                                                    ${day.isCycleEnd ? 'border-r-yellow-400 border-r-2 print-cycle-end' : ''}
                                                `}
                                                title={isUnderstaffed ? `人力不足！早班: ${morningText}, 晚班: ${eveningText}` : `人力充足。早班: ${morningText}, 晚班: ${eveningText}`}
                                            >
                                                <div className="flex flex-col gap-0.5">
                                                    <span>早:{audit.morning} (需{audit.requiredM})</span>
                                                    <span>晚:{audit.evening} (需{audit.requiredE})</span>
                                                </div>
                                            </th>
                                        );
                                    })}
                                    <th className="sticky right-0 bg-gray-200 text-center text-xs font-semibold text-gray-700 py-1 px-3 border-l border-b border-gray-300 w-24 min-w-[96px] shadow-sm">
                                        N/A
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {/* 使用者排班資料行 */}
                                {scheduleData.map((user, userIndex) => {
                                    const isCurrentUser = user.id === userId;
                                    const isEditable = isCurrentUser;
                                    
                                    // 計算使用者週期總結 (範例：四週內休假 R/H 總天數)
                                    let totalRestDays = 0;
                                    dateList.forEach(day => {
                                        const shiftCode = user.schedule?.[day.dateStr] || '-';
                                        if (['R', 'H'].includes(shiftCode)) {
                                            totalRestDays++;
                                        }
                                    });
                                    
                                    return (
                                        <tr key={user.id} className={`${isCurrentUser ? 'bg-blue-50 hover:bg-blue-100/70' : 'bg-white hover:bg-gray-50'}`}>
                                            <td className="sticky left-0 bg-white text-left text-sm font-medium text-gray-900 py-2 px-3 border-r border-b border-gray-300 whitespace-nowrap shadow-sm">
                                                <div className="flex items-center space-x-2">
                                                    {/* 使用 UserIcon 或其 fallback */}
                                                    {isCurrentUser 
                                                        ? <UserIcon className="w-4 h-4 text-blue-500" /> 
                                                        : <LockIcon className="w-4 h-4 text-gray-400" />
                                                    }
                                                    <span className={`${isCurrentUser ? 'font-bold text-gray-800' : 'text-gray-700'}`}>
                                                        {user.displayName}
                                                    </span>
                                                </div>
                                            </td>
                                            {dateList.map((day, index) => {
                                                const dateStr = day.dateStr;
                                                const shiftCode = user.schedule?.[dateStr] || '-';
                                                const isCycleEnd = day.isCycleEnd;
                                                const audit = shiftAudit[user.id]?.[dateStr];
                                                // 檢查 B06 -> A07 規則
                                                const isValid = audit ? audit.isRuleValid : true;

                                                return (
                                                    <td 
                                                        key={dateStr}
                                                        className={`text-center py-0.5 px-0.5 border-r border-b border-gray-300 
                                                            ${day.isWeekend || day.isNationalHoliday ? 'bg-red-50/50' : ''}
                                                            ${isCycleEnd ? 'border-r-yellow-400 border-r-2 print-cycle-end' : ''}
                                                        `}
                                                    >
                                                        <ShiftCell
                                                            shiftCode={shiftCode}
                                                            isEditable={isEditable}
                                                            dateStr={dateStr}
                                                            scheduleId={user.id}
                                                            isValid={isValid}
                                                        />
                                                    </td>
                                                );
                                            })}
                                            {/* 週期總結欄位 */}
                                            <td className="sticky right-0 bg-white text-center text-xs font-medium text-gray-700 py-2 px-3 border-l border-b border-gray-300 whitespace-nowrap shadow-sm">
                                                <span className="font-bold text-lg text-blue-500">{totalRestDays}</span> 天假
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            };

            if (isLoading) {
                // 使用 LoaderIcon 或其 fallback
                const LoaderIcon = Loader || 'div';
                return (
                    <div className="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-lg border border-gray-100 max-w-sm w-full mx-auto">
                        <LoaderIcon className="w-8 h-8 text-blue-500 animate-spin mb-4" />
                        <p className="text-gray-600 font-medium text-center">正在初始化 Firebase 並載入排班表...</p>
                    </div>
                );
            }

            if (error) {
                // 使用 AlertTriangle 或其 fallback
                const AlertIcon = AlertTriangle || 'div';
                return (
                     <div className="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-lg border border-red-200 max-w-sm w-full mx-auto">
                        <AlertIcon className="w-8 h-8 text-red-500 mb-4" />
                        <p className="text-red-700 font-bold text-center mb-2">發生錯誤</p>
                        <p className="text-gray-600 text-sm text-center">{error}</p>
                    </div>
                );
            }
            
            // App Main Render
            const SettingsIcon = Settings || 'div';

            return (
                <div className="container max-w-6xl mx-auto p-4 space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-4 print:hidden">
                        <div className="flex flex-col">
                            <h1 className="text-3xl font-extrabold text-gray-800">
                                {year} 年 {month} 月 排班表
                            </h1>
                            <p className="text-sm text-gray-500 mt-1">
                                歡迎，<span className="font-semibold text-blue-500">{userDisplayName}</span> | 您的 ID: <span className="text-xs font-mono bg-gray-100 px-1 rounded">{userId}</span>
                            </p>
                        </div>
                        <div className="flex space-x-2 mt-3 sm:mt-0">
                            {/* 月份切換 */}
                            <select 
                                value={month} 
                                onChange={(e) => setMonth(parseInt(e.target.value))}
                                className="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled={isSaving}
                            >
                                {Array.from({ length: 12 }, (_, i) => i + 1).map(m => (
                                    <option key={m} value={m}>{m} 月</option>
                                ))}
                            </select>
                            <button
                                onClick={() => window.print()}
                                className="flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg shadow-sm hover:bg-gray-300 transition-colors"
                            >
                                <SettingsIcon className="w-4 h-4 mr-2" />
                                列印/匯出
                            </button>
                        </div>
                    </header>
                    
                    <ScheduleTable />
                    
                    <div className="mt-6 text-sm text-gray-600 space-y-3 print:hidden p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                        <h3 className="text-lg font-bold text-gray-800 border-b pb-2 mb-2">排班規則說明</h3>
                        <ul className="list-disc list-inside space-y-2">
                            <li><span className="font-semibold">班別規則：</span>
                                <ul className="list-circle list-inside ml-4">
                                    <li><span className="font-bold">B06</span> 隔天 <span className="text-red-600 font-bold">不能</span> 排 <span className="font-bold">A07</span> (將被標記 <span className="bg-red-100/70 px-1 rounded">淺紅底色</span>)。</li>
                                </ul>
                            </li>
                            <li><span className="font-semibold">人力規則：</span>
                                <ul className="list-circle list-inside ml-4">
                                    <li>平日 (週一至週五) 假設需 <span className="font-bold">2早2晚</span>。</li>
                                    <li>假日 (一般週末) 假設需 <span className="font-bold">1早1晚</span>。</li>
                                    <li>2/16 國定假日較特殊，僅需 <span className="font-bold">1早0晚</span>。</li>
                                    <li>人力不足的日子，<span className="text-red-600 font-bold">人力總結</span> 欄位會以 <span className="bg-red-200/50 px-1 rounded">淺紅底色</span> 標示。</li>
                                </ul>
                            </li>
                            <li><span className="font-semibold">標示說明：</span>
                                <ul className="list-circle list-inside ml-4">
                                    <li><span className="text-red-600 font-bold">紅色字體班別</span> (如 R/H/O) 為休假日或特殊班。</li>
                                    <li>週期標示：<span className="bg-yellow-100 px-1 rounded">黃色粗線與底色</span> 標示四週變形工時的結算日。</li>
                                    <li><span className="bg-blue-50 font-bold">淺藍底色行</span> 為您自己的排班。</li>
                                </ul>
                            </li>
                            <li><span className="font-semibold">編輯權限：</span>只有您本人可以點擊編輯自己列的班別 (點擊班別會循環切換班別，點擊相同班別則設為 '-')。</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // React 18 根渲染
        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);
        } else {
            console.error("Root element with id 'root' not found!");
        }
    </script>
</body>
</html>