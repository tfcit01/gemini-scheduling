<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026(115)年 四週變形線上排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .print-border { border: 1px solid #000 !important; }
            .print-container { width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            /* Force background colors in print */
            .bg-blue-100 { background-color: #dbeafe !important; }
            .bg-gray-100 { background-color: #f3f4f6 !important; }
            .bg-yellow-200 { background-color: #fef08a !important; }
            .bg-red-50 { background-color: #fef2f2 !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
        }
        
        /* Custom Scrollbar for horizontal scrolling */
        .scroller::-webkit-scrollbar { height: 8px; }
        .scroller::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        /* Input styling to look like plain text but editable */
        .cell-input {
            width: 100%;
            height: 100%;
            text-align: center;
            background: transparent;
            outline: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }
        .cell-input:focus { background: #eef2ff; }
        
        /* Red Text for holidays */
        .text-holiday { color: #dc2626; font-weight: bold; }
        
        /* Tentative style */
        .is-tentative { background-color: #bae6fd !important; /* Sky Blue */ }
        
        /* Cycle End Column */
        .cycle-end { border-right: 3px solid #9ca3af !important; background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<div id="app" class="pb-20">
    <header class="bg-white shadow p-4 no-print sticky top-0 z-50">
        <div class="max-w-full mx-auto flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-gray-700">2026(115)年 四週變形排班系統</h1>
                <p class="text-xs text-gray-500">Firebase 連線狀態: <span :class="firebaseStatus === '已連線' ? 'text-green-600' : 'text-red-600'">{{ firebaseStatus }}</span></p>
            </div>

            <div class="flex items-center gap-2 bg-gray-100 p-2 rounded">
                <button @click="changeMonth(-1)" class="px-3 py-1 bg-white border rounded hover:bg-gray-50">&lt;</button>
                <span class="text-lg font-bold min-w-[80px] text-center">{{ currentYear }}年 {{ currentMonth + 1 }}月</span>
                <button @click="changeMonth(1)" class="px-3 py-1 bg-white border rounded hover:bg-gray-50">&gt;</button>
            </div>

            <div class="flex flex-wrap gap-2 items-center">
                <label class="flex items-center space-x-2 cursor-pointer bg-blue-50 px-3 py-1 rounded border border-blue-200">
                    <input type="checkbox" v-model="tentativeMode" class="form-checkbox h-4 w-4 text-blue-600">
                    <span class="text-sm font-medium text-blue-800">標記不確定 (點擊儲存格)</span>
                </label>
                <button @click="printSchedule" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                    列印 / 存為PDF
                </button>
            </div>
        </div>
        
        <div class="mt-4 text-xs flex flex-wrap gap-4 text-gray-600 border-t pt-2">
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-100 border border-red-300"></span> 國定/例假 (H/O/R)</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-200 border border-blue-300"></span> 可能休假 (Tentative)</span>
            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-200 border border-green-300"></span> 2/16 特殊日</span>
            <span>規則: B06隔日禁排A01</span>
        </div>
    </header>

    <main class="p-4 print-container">
        
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow border print-border">
                <h3 class="font-bold text-sm mb-2 border-b pb-1">國定假日 (H) 統計 (截至目前)</h3>
                <div class="grid grid-cols-5 gap-2 text-sm text-center font-bold bg-gray-100 p-1 rounded-t">
                    <div class="text-left pl-2">姓名</div>
                    <div>應休</div>
                    <div>已排</div>
                    <div>剩餘</div>
                    <div>狀態</div>
                </div>
                <div v-for="(name, idx) in staffNames" :key="idx" class="grid grid-cols-5 gap-2 text-sm text-center border-b py-1">
                    <div class="text-left pl-2 text-gray-700">{{ name }}</div>
                    <div class="text-gray-500">{{ totalHolidaysPassed }}</div>
                    <div class="text-blue-600">{{ countShiftType(idx, 'H') }}</div>
                    <div :class="getHBalance(idx) < 0 ? 'text-red-500' : 'text-green-600'">
                        {{ getHBalance(idx) }}
                    </div>
                    <div class="text-xs flex items-center justify-center">
                        <span v-if="getHBalance(idx) > 0" class="px-1 bg-red-100 text-red-700 rounded">未休完</span>
                        <span v-else class="text-green-500">OK</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow border print-border">
                <h3 class="font-bold text-sm mb-2 border-b pb-1">四週變形工時檢核 (本月相關週期)</h3>
                <div v-for="cycle in currentMonthCycles" :key="cycle.id" class="mb-3">
                    <div class="text-xs font-bold bg-yellow-100 px-2 py-1 rounded mb-1">
                        週期: {{ formatDateShort(cycle.start) }} ~ {{ formatDateShort(cycle.end) }} (需 4R + 4O)
                    </div>
                    <div class="grid grid-cols-5 gap-1 text-xs text-center">
                        <div class="font-bold text-gray-500">姓名</div>
                        <div v-for="(name, idx) in staffNames" :key="'h'+idx" class="text-gray-700">{{ name }}</div>
                        
                        <div class="font-bold text-blue-600">R (休)</div>
                        <div v-for="(name, idx) in staffNames" :key="'r'+idx" 
                             :class="getCycleCount(cycle, idx, 'R') < 4 ? 'text-red-600 font-bold bg-red-50' : 'text-green-600'">
                            {{ getCycleCount(cycle, idx, 'R') }}
                        </div>

                        <div class="font-bold text-red-600">O (例)</div>
                        <div v-for="(name, idx) in staffNames" :key="'o'+idx"
                             :class="getCycleCount(cycle, idx, 'O') < 4 ? 'text-red-600 font-bold bg-red-50' : 'text-green-600'">
                            {{ getCycleCount(cycle, idx, 'O') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="warnings.length > 0" class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm no-print">
            <strong>排班警告：</strong>
            <ul class="list-disc pl-5 mt-1">
                <li v-for="(warn, wIdx) in warnings" :key="wIdx">{{ warn }}</li>
            </ul>
        </div>

        <div class="overflow-x-auto scroller border border-gray-300 shadow bg-white print-border">
            <table class="w-full border-collapse text-center text-sm whitespace-nowrap">
                <thead>
                    <tr class="bg-blue-600 text-white">
                        <th class="p-2 border border-blue-700 min-w-[80px] sticky left-0 bg-blue-600 z-10">姓名</th>
                        <th v-for="day in daysInMonth" :key="day.dateStr" 
                            class="border border-blue-500 min-w-[36px] px-1 py-2"
                            :class="{
                                'bg-red-500': isHolidayOrWeekend(day), 
                                'bg-green-600': day.dateStr === '2026-02-16',
                                'cycle-end': isCycleEnd(day.dateStr)
                            }"
                        >
                            <div class="text-xs opacity-80">{{ getDayName(day.date) }}</div>
                            <div class="font-bold text-lg">{{ day.dayNum }}</div>
                            <div v-if="isNationalHoliday(day.dateStr)" class="text-[10px] bg-white text-red-600 rounded px-1 mt-1 inline-block">H</div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(name, sIdx) in staffNames" :key="sIdx" class="hover:bg-gray-50">
                        <td class="border p-0 sticky left-0 bg-white z-10 font-bold text-gray-700 min-w-[80px]">
                            <input v-model="staffNames[sIdx]" @change="saveStaffNames" class="w-full h-10 text-center outline-none bg-transparent focus:bg-yellow-50" />
                        </td>
                        
                        <td v-for="day in daysInMonth" :key="day.dateStr" 
                            class="border p-0 h-10 relative"
                            :class="{
                                'bg-red-50': isHolidayOrWeekend(day),
                                'bg-green-50': day.dateStr === '2026-02-16',
                                'cycle-end': isCycleEnd(day.dateStr),
                                'is-tentative': isTentative(day.dateStr, sIdx)
                            }"
                            @click="handleCellClick(day.dateStr, sIdx)"
                        >
                            <input 
                                :list="'shifts'" 
                                :value="getShift(day.dateStr, sIdx)"
                                @input="updateShift(day.dateStr, sIdx, $event.target.value)"
                                class="cell-input"
                                :class="{
                                    'text-holiday': ['R','O','H'].includes(getShift(day.dateStr, sIdx)),
                                    'text-blue-600': getShift(day.dateStr, sIdx).startsWith('A'),
                                    'text-gray-800': getShift(day.dateStr, sIdx).startsWith('B')
                                }"
                            >
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <datalist id="shifts">
            <option value="A01">早班 A01</option>
            <option value="A07">早班 A07</option>
            <option value="A13">早班 A13</option>
            <option value="B05">晚班 B05</option>
            <option value="B06">晚班 B06</option>
            <option value="R">休息日 (R)</option>
            <option value="O">例假日 (O)</option>
            <option value="H">國定假 (H)</option>
            <option value="">(空)</option>
        </datalist>

    </main>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDCEvRaXA6WZsNm9ieWkWbqd5WulYhLHZU",
    authDomain: "studio-8052896891-3435d.firebaseapp.com",
    projectId: "studio-8052896891-3435d",
    storageBucket: "studio-8052896891-3435d.firebasestorage.app",
    messagingSenderId: "1018029524188",
    appId: "1:1018029524188:web:f81bd6343ed0f4bbe6a019"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const app = Vue.createApp({
    data() {
        return {
            currentYear: 2026,
            currentMonth: 0, // 0 = Jan
            staffNames: ['蔡定緯', '林家傑', '邱奕瑋', '陶楷頤'],
            shiftsData: {}, // Format: { "YYYY-MM-DD": ["Code", "Code", "Code", "Code"] }
            tentativeData: {}, // Format: { "YYYY-MM-DD-Idx": true }
            tentativeMode: false,
            firebaseStatus: '連線中...',
            
            // 4-Week Cycles Configuration (Derived from PDF)
            // Start 2025-12-22, then +28 days recursively
            cycleStartBase: new Date('2025-12-22'),
            
            // National Holidays 2026 (From PDF & TW Calendar Logic)
            // Note: 2/16 is special Eve.
            nationalHolidays: [
                '2026-01-01', // Founding Day
                '2026-02-16', // Eve (Special)
                '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', // LNY
                '2026-02-28', // Peace
                '2026-04-03', '2026-04-04', '2026-04-06', // Children/Tomb (Adjusted)
                '2026-05-01', // Labor
                '2026-06-19', // Dragon Boat
                '2026-09-25', // Moon Festival
                '2026-10-10'  // National Day
                // Total roughly 16 days as per prompt. 
                // Logic: Users can't use H before date.
            ]
        }
    },
    computed: {
        daysInMonth() {
            const date = new Date(this.currentYear, this.currentMonth, 1);
            const days = [];
            while (date.getMonth() === this.currentMonth) {
                const dateStr = date.toISOString().split('T')[0];
                days.push({
                    date: new Date(date),
                    dateStr: dateStr,
                    dayNum: date.getDate()
                });
                date.setDate(date.getDate() + 1);
            }
            return days;
        },
        // Calculate which 4-week cycles intersect with current month
        currentMonthCycles() {
            const cycles = [];
            // Generate cycles dynamically
            let current = new Date(this.cycleStartBase);
            const viewStart = new Date(this.currentYear, this.currentMonth, 1);
            const viewEnd = new Date(this.currentYear, this.currentMonth + 1, 0);
            
            // Look ahead enough cycles (e.g., 15) to cover the year
            for(let i=0; i<14; i++) {
                let end = new Date(current);
                end.setDate(end.getDate() + 27); // 4 weeks - 1 day
                
                // If cycle overlaps with current month
                if (current <= viewEnd && end >= viewStart) {
                    cycles.push({
                        id: i,
                        start: new Date(current),
                        end: new Date(end),
                        startStr: current.toISOString().split('T')[0],
                        endStr: end.toISOString().split('T')[0]
                    });
                }
                
                // Next cycle
                current.setDate(current.getDate() + 28);
            }
            return cycles;
        },
        // Calculate total H passed so far in the year (for accounting)
        totalHolidaysPassed() {
            const today = new Date();
            // In a real app, maybe use current selected month's end, 
            // but for "Available H", usually it's based on "Have we passed this date?"
            // Prompt says: "Cannot use H before it happens".
            // Let's count H in valid holidays array that are <= current viewed month's end.
            const monthEndStr = new Date(this.currentYear, this.currentMonth + 1, 0).toISOString().split('T')[0];
            return this.nationalHolidays.filter(h => h <= monthEndStr).length;
        },
        warnings() {
            const warns = [];
            const days = this.daysInMonth;
            
            days.forEach(day => {
                const dStr = day.dateStr;
                const shifts = this.shiftsData[dStr] || ['', '', '', ''];
                
                // Count shifts
                let morning = 0;
                let evening = 0;
                shifts.forEach(s => {
                    if(s && s.startsWith('A')) morning++;
                    if(s && s.startsWith('B')) evening++;
                });

                // Rule 1: Min 1 A, 1 B (Normal days)
                // Check if totally empty to avoid spamming warnings on empty month
                const hasAny = shifts.some(s => s !== '');
                if (hasAny && !this.isNationalHoliday(dStr) && dStr !== '2026-02-16') {
                   // Optional: Strict enforcement warning? 
                   // Prompt says "Minimum 1 morning 1 evening".
                   if(morning < 1) warns.push(`${dStr}: 缺少早班`);
                   if(evening < 1) warns.push(`${dStr}: 缺少晚班`);
                }

                // Rule 3: Holiday/Weekend limits
                const isHol = this.isNationalHoliday(dStr) || [0,6].includes(day.date.getDay());
                if (hasAny && isHol && dStr !== '2026-02-16') {
                    if (morning > 1 || evening > 1) {
                        warns.push(`${dStr} (假日/週末): 人力不可多於 1早 1晚`);
                    }
                }

                // Rule 3 Exception: 2/16
                if (dStr === '2026-02-16' && hasAny) {
                    if (morning !== 1) warns.push(`2/16 除夕前日: 需剛好 1 名早班`);
                    if (evening > 0) warns.push(`2/16 除夕前日: 不可安排晚班`);
                }
                
                // Rule 2: B06 -> A01 check
                // Need prev day
                let prevDate = new Date(day.date);
                prevDate.setDate(prevDate.getDate() - 1);
                const prevStr = prevDate.toISOString().split('T')[0];
                const prevShifts = this.shiftsData[prevStr];
                
                if (prevShifts) {
                    shifts.forEach((code, idx) => {
                        if (code === 'A01' && prevShifts[idx] === 'B06') {
                            warns.push(`${dStr} (${this.staffNames[idx]}): B06 後不可接 A01`);
                        }
                    });
                }
            });
            
            return warns.slice(0, 5); // Limit display
        }
    },
    methods: {
        changeMonth(delta) {
            let newM = this.currentMonth + delta;
            if (newM > 11) { newM = 11; } 
            if (newM < 0) { newM = 0; }
            this.currentMonth = newM;
        },
        getDayName(date) {
            const map = ['日','一','二','三','四','五','六'];
            return map[date.getDay()];
        },
        formatDateShort(date) {
            return `${date.getMonth()+1}/${date.getDate()}`;
        },
        isNationalHoliday(dateStr) {
            return this.nationalHolidays.includes(dateStr);
        },
        isHolidayOrWeekend(day) {
            // Weekend (Sat/Sun) OR National Holiday
            return day.date.getDay() === 0 || day.date.getDay() === 6 || this.isNationalHoliday(day.dateStr);
        },
        isCycleEnd(dateStr) {
            // Calculate days diff from base
            const target = new Date(dateStr);
            const diffTime = target - this.cycleStartBase;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            // Cycle is 28 days. Ends are 27, 55, 83... (0-indexed 27)
            // 12/22 is day 0. 1/18 is day 27.
            return (diffDays + 1) % 28 === 0 && diffDays >= 0;
        },
        getShift(dateStr, idx) {
            if (!this.shiftsData[dateStr]) return '';
            return this.shiftsData[dateStr][idx] || '';
        },
        updateShift(dateStr, idx, value) {
            value = value.toUpperCase();
            if (!this.shiftsData[dateStr]) {
                this.shiftsData[dateStr] = ['', '', '', ''];
            }
            this.shiftsData[dateStr][idx] = value;
            this.saveToFirebase();
        },
        handleCellClick(dateStr, idx) {
            if (this.tentativeMode) {
                const key = `${dateStr}-${idx}`;
                this.tentativeData[key] = !this.tentativeData[key];
                this.saveToFirebase(); // Save tentative state
            }
        },
        isTentative(dateStr, idx) {
            return !!this.tentativeData[`${dateStr}-${idx}`];
        },
        
        // Counters
        countShiftType(staffIdx, type) {
            // Count total in the WHOLE year (from loaded data)
            // Note: In a real large app, we might query DB. Here we load all relevant data.
            // For simplicity, we iterate loaded `shiftsData`. 
            // Warning: If we only lazy load months, this is inaccurate.
            // But for this single-year lightweight tool, we assume shiftsData holds the year.
            let count = 0;
            Object.keys(this.shiftsData).forEach(d => {
                if (d.startsWith(this.currentYear.toString())) {
                    if (this.shiftsData[d][staffIdx] === type) count++;
                }
            });
            return count;
        },
        getHBalance(staffIdx) {
            const used = this.countShiftType(staffIdx, 'H');
            return this.totalHolidaysPassed - used;
        },
        getCycleCount(cycle, staffIdx, type) {
            let count = 0;
            let curr = new Date(cycle.start);
            while(curr <= cycle.end) {
                const dStr = curr.toISOString().split('T')[0];
                const s = this.getShift(dStr, staffIdx);
                if (s === type) count++;
                curr.setDate(curr.getDate() + 1);
            }
            return count;
        },

        // Firebase Sync
        saveToFirebase() {
            db.collection('schedule_2026').doc('main_data').set({
                shifts: this.shiftsData,
                tentative: this.tentativeData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        },
        saveStaffNames() {
            db.collection('schedule_2026').doc('config').set({
                names: this.staffNames
            }, { merge: true });
        },
        loadData() {
            // Listener for Data
            db.collection('schedule_2026').doc('main_data')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        this.shiftsData = data.shifts || {};
                        this.tentativeData = data.tentative || {};
                    }
                });
            
            // Listener for Config
            db.collection('schedule_2026').doc('config')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        this.staffNames = doc.data().names || this.staffNames;
                    }
                });
        },
        printSchedule() {
            window.print();
        }
    },
    mounted() {
        // Anonymous Login
        auth.signInAnonymously()
            .then(() => {
                this.firebaseStatus = '已連線';
                this.loadData();
            })
            .catch((error) => {
                console.error("Auth Error", error);
                this.firebaseStatus = '連線失敗';
            });
    }
});

app.mount('#app');
</script>

</body>
</html>