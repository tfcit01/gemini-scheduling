<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 線上排班系統 (GitHub/Firebase)</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入 Firebase (v11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 設定 Firebase 日誌級別
        // setLogLevel('debug');

        // 檢查全域變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (firebaseConfig) {
            // 初始化 Firebase
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            window.appId = appId;
            
            console.log('Firebase initialized for App ID:', appId);
            
            // 登入或匿名登入
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                            console.log('Signed in with custom token.');
                        } else {
                            await signInAnonymously(window.auth);
                            console.log('Signed in anonymously.');
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                } else {
                    console.log('User is already signed in:', user.uid);
                }
            });

            // 匯出必要的 Firestore/Auth 函式到 window 物件，供 React 腳本使用
            // 修正重點：確保 onAuthStateChanged 被正確暴露
            window.firebase = {
                doc, getDoc, setDoc, onSnapshot, collection, query, where, updateDoc,
                onAuthStateChanged
            };

        } else {
            console.error("Firebase config is missing. Firestore features will be disabled.");
        }
    </script>

    <style>
        /* 列印樣式設定 */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .print\:text-xs { font-size: 10px !important; }
            .print\:bg-gray-100 { background-color: #f3f4f6 !important; }
            .print\:border-gray-300 { border-color: #d1d5db !important; }
            .print\:border-yellow-400 { border-color: #facc15 !important; }
            .print\:border-r-2 { border-right-width: 2px !important; }
            .print\:text-red-600 { color: #dc2626 !important; }
            .print\:font-bold { font-weight: 700 !important; }
        }

        /* 隱藏預設的 Spinner 箭頭 */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='number'] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // 全域常量
        const COLLECTION_NAME = "shift_schedule_2026";
        const WORKERS = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛'];
        const SHIFTS = ['A07', 'B08', 'C09', 'D10', 'E11', 'F12', 'G01', 'H-Holiday', 'R-Rest', 'O-Other', 'B06'];
        const SHIFT_MAP = {
            'A07': { type: 'early', hours: 8, color: 'text-green-600' },
            'B08': { type: 'early', hours: 8, color: 'text-green-600' },
            'C09': { type: 'early', hours: 8, color: 'text-green-600' },
            'D10': { type: 'early', hours: 8, color: 'text-green-600' },
            'E11': { type: 'early', hours: 8, color: 'text-green-600' },
            'F12': { type: 'late', hours: 8, color: 'text-blue-600' },
            'G01': { type: 'late', hours: 8, color: 'text-blue-600' },
            'B06': { type: 'late', hours: 8, color: 'text-blue-600' }, // B06 視為晚班, 雖然實際上是早班但接替 B08 的隔天休息規則
            'H-Holiday': { type: 'rest', hours: 0, color: 'text-red-600' },
            'R-Rest': { type: 'rest', hours: 0, color: 'text-red-600' },
            'O-Other': { type: 'rest', hours: 0, color: 'text-red-600' },
        };
        const DAY_NAMES = ['日', '一', '二', '三', '四', '五', '六'];
        
        // 特殊日期規則
        const REQUIRED_WORKERS = {
            // 假日/國定假日: 需剛好 1早1晚
            '2026-01-01': { total: 2, early: 1, late: 1 }, // 元旦
            '2026-01-25': { total: 2, early: 1, late: 1 }, // 春節 (日)
            '2026-01-26': { total: 2, early: 1, late: 1 }, // 春節
            '2026-01-27': { total: 2, early: 1, late: 1 }, // 春節
            '2026-01-28': { total: 2, early: 1, late: 1 }, // 春節
            '2026-02-08': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-02-15': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-02-16': { total: 1, early: 1, late: 0 }, // 僅需 1早
            '2026-02-22': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-02-28': { total: 2, early: 1, late: 1 }, // 228
            '2026-03-08': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-03-15': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-03-22': { total: 2, early: 1, late: 1 }, // 假日 (日)
            '2026-03-29': { total: 2, early: 1, late: 1 }, // 假日 (日)
        };

        // 變形工時週期結束日期 (需加上 1 天作為結算日後的第一天)
        const CYCLE_END_DATES = ['2026-01-18', '2026-02-15', '2026-03-15'];

        /**
         * 檢查班別規則：B06 隔天僅能排 A07
         * @param {string} currentShift 當天的班別
         * @param {string} nextShift 隔天的班別
         * @returns {boolean} 是否符合規則
         */
        const checkShiftRule = (currentShift, nextShift) => {
            if (currentShift === 'B06' && nextShift !== 'A07' && SHIFT_MAP[nextShift]?.type !== 'rest') {
                return false;
            }
            return true;
        };

        /**
         * 檢查人力規則
         * @param {string} dateString 日期字串 (YYYY-MM-DD)
         * @param {object} dailySummary 當日早晚班人數統計 {early: number, late: number, rest: number}
         * @returns {boolean} 是否符合規則
         */
        const checkManpowerRule = (dateString, dailySummary) => {
            const date = new Date(dateString);
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

            const required = REQUIRED_WORKERS[dateString];

            if (required) {
                // 特殊日期規則
                return dailySummary.early === required.early && dailySummary.late === required.late;
            } else if (isWeekend) {
                // 一般週末/假日規則: 需剛好 1早1晚
                return dailySummary.early === 1 && dailySummary.late === 1;
            } else {
                // 平日規則: 至少 1早1晚
                return dailySummary.early >= 1 && dailySummary.late >= 1; 
            }
        };

        /**
         * 轉換日期物件為 YYYY-MM-DD 字串
         */
        const formatDate = (date) => {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        };

        /**
         * 獲取一個月的所有日期 (包含上個月和下個月的補齊日期)
         * @param {number} year 年
         * @param {number} month 月 (1-12)
         * @returns {Array<{date: Date, isCurrentMonth: boolean, dateString: string}>}
         */
        const getMonthDates = (year, month) => {
            const firstDayOfMonth = new Date(year, month - 1, 1);
            const lastDayOfMonth = new Date(year, month, 0);

            const dates = [];
            
            // 補齊前一個月的日期 (讓第一天是星期日)
            let dayOfWeekOfFirstDay = firstDayOfMonth.getDay();
            if (dayOfWeekOfFirstDay !== 0) {
                for (let i = dayOfWeekOfFirstDay; i > 0; i--) {
                    const date = new Date(firstDayOfMonth);
                    date.setDate(firstDayOfMonth.getDate() - i);
                    dates.push({ date, isCurrentMonth: false, dateString: formatDate(date) });
                }
            }
            
            // 當月日期
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const date = new Date(year, month - 1, i);
                dates.push({ date, isCurrentMonth: true, dateString: formatDate(date) });
            }

            // 補齊下一個月的日期 (讓最後一天是星期六)
            let dayOfWeekOfLastDay = lastDayOfMonth.getDay();
            if (dayOfWeekOfLastDay !== 6) {
                for (let i = 1; i <= (6 - dayOfWeekOfLastDay); i++) {
                    const date = new Date(lastDayOfMonth);
                    date.setDate(lastDayOfMonth.getDate() + i);
                    dates.push({ date, isCurrentMonth: false, dateString: formatDate(date) });
                }
            }

            return dates;
        };


        // =================================================================
        // React App Component
        // =================================================================

        const App = () => {
            const [currentMonth, setCurrentMonth] = useState(1);
            const [currentYear, setCurrentYear] = useState(2026);
            const [scheduleData, setScheduleData] = useState({});
            const [selectedMonth, setSelectedMonth] = useState(1); // 用於月份選擇器
            const [selectedYear, setSelectedYear] = useState(2026); // 用於年份選擇器
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const [isDraftMode, setIsDraftMode] = useState(false); // 預排模式 (淺藍底色)
            const [draftData, setDraftData] = useState({}); // 預排資料 (未儲存到 Firestore)

            // 存儲資料庫實例
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState(null);
            const [auth, setAuth] = useState(null);

            // ===================================
            // Firebase/Auth Setup (修正錯誤的核心區塊)
            // ===================================

            useEffect(() => {
                if (window.db && window.auth && window.appId && window.firebase.onAuthStateChanged) {
                    setDb(window.db);
                    setAuth(window.auth);
                    setAppId(window.appId);

                    // 修正：使用 window.firebase.onAuthStateChanged 函式並傳入 window.auth 實例
                    const unsubscribe = window.firebase.onAuthStateChanged(window.auth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("Auth State Changed: User ID set to", user.uid);
                        } else {
                            // 應該在 module script 中處理登入，此處只做狀態監聽
                            setUserId(null); 
                            console.log("Auth State Changed: User is signed out or anonymous.");
                        }
                        setIsAuthReady(true); // 認證狀態已準備好，可以開始讀取 Firestore
                    });

                    return () => {
                        console.log("Detaching Auth listener.");
                        unsubscribe();
                    };
                } else if (!window.firebase?.onAuthStateChanged) {
                    // 如果 Firebase 函式未暴露，則僅標記認證完成，但無法使用即時功能
                    setIsAuthReady(true);
                    console.error("Firebase Auth Listener function is missing from window.firebase.");
                }
            }, []); // Run only once for initialization


            // ===================================
            // Data Fetching (Firestore onSnapshot)
            // ===================================

            useEffect(() => {
                if (!db || !userId || !isAuthReady) {
                    console.log("Waiting for DB, Auth, or Auth Ready...");
                    return;
                }

                // Firestore collection path
                // Public data path: /artifacts/{appId}/public/data/{COLLECTION_NAME}
                const docRef = window.firebase.doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                
                console.log("Attaching onSnapshot listener to:", docRef.path);

                const unsubscribe = window.firebase.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // 確保只有排班資料被設置，並忽略其他可能的欄位
                        const schedule = Object.keys(data).reduce((acc, key) => {
                            if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                acc[key] = data[key];
                            }
                            return acc;
                        }, {});
                        setScheduleData(schedule);
                        console.log("Fetched new schedule data:", Object.keys(schedule).length, "days");
                    } else {
                        setScheduleData({});
                        console.log("Document does not exist, starting fresh.");
                    }
                    setDraftData({}); // 每次從 Firestore 讀取新資料後，清除預排
                }, (error) => {
                    console.error("Firestore onSnapshot error:", error);
                });

                return () => {
                    console.log("Detaching onSnapshot listener.");
                    unsubscribe();
                };
            }, [db, userId, appId, isAuthReady]); // Depend on db, userId, and isAuthReady

            // ===================================
            // Data Manipulation and Saving
            // ===================================

            /**
             * 根據當前模式 (正式/預排) 獲取資料
             */
            const getCurrentData = useCallback(() => {
                return isDraftMode ? { ...scheduleData, ...draftData } : scheduleData;
            }, [scheduleData, draftData, isDraftMode]);


            /**
             * 處理班別變更
             * @param {string} dateString YYYY-MM-DD
             * @param {string} worker 員工名稱
             * @param {string} shift 新班別
             */
            const handleShiftChange = useCallback((dateString, worker, shift) => {
                const newData = getCurrentData();
                const dayData = newData[dateString] || {};
                
                // 更新當天該員工的班別
                const newDayData = {
                    ...dayData,
                    [worker]: shift,
                };

                const updatedData = {
                    ...scheduleData,
                    ...draftData,
                    [dateString]: newDayData,
                };
                
                if (isDraftMode) {
                    // 更新 draftData
                    setDraftData(prev => ({
                        ...prev,
                        [dateString]: newDayData
                    }));
                } else {
                    // 更新 scheduleData (直接進入儲存流程)
                    // Note: Here we are updating scheduleData state first for immediate UI refresh
                    setScheduleData(updatedData);
                    // And then triggering the save with the full updated data
                    saveSchedule(updatedData); 
                }
            }, [scheduleData, draftData, isDraftMode, getCurrentData]);

            /**
             * 儲存資料到 Firestore
             * @param {object} data 要儲存的排班資料
             */
            const saveSchedule = useCallback(async (data) => {
                if (!db || !userId || isDraftMode) {
                    console.warn("Cannot save: DB not ready, user not authenticated, or currently in draft mode.");
                    if (isDraftMode) {
                        setSaveMessage('請先切換至「正式模式」再儲存。');
                        setTimeout(() => setSaveMessage(''), 3000);
                    }
                    return;
                }

                setIsSaving(true);
                setSaveMessage('儲存中...');
                
                // Public data path: /artifacts/{appId}/public/data/{COLLECTION_NAME}
                const docRef = window.firebase.doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);

                // 準備要寫入的資料 (只儲存排班數據)
                const dataToSave = Object.keys(data).reduce((acc, key) => {
                    if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        acc[key] = data[key];
                    }
                    return acc;
                }, {});

                try {
                    // 使用 setDoc 進行寫入，merge: true 確保只更新排班資料而不影響其他可能的欄位
                    await window.firebase.setDoc(docRef, dataToSave, { merge: true });
                    setSaveMessage('儲存成功！');
                    console.log("Schedule saved successfully.");
                } catch (error) {
                    setSaveMessage('儲存失敗：' + error.message);
                    console.error("Error saving schedule:", error);
                } finally {
                    setIsSaving(false);
                    setTimeout(() => setSaveMessage(''), 3000);
                }
            }, [db, userId, appId, isDraftMode]);


            // ===================================
            // Computed Values
            // ===================================

            const allDates = useMemo(() => getMonthDates(currentYear, currentMonth), [currentYear, currentMonth]);
            const scheduleForDisplay = getCurrentData();

            // 計算每日人力總結和規則驗證
            const dailySummaries = useMemo(() => {
                return allDates.reduce((acc, { dateString }) => {
                    const dayData = scheduleForDisplay[dateString] || {};
                    let early = 0;
                    let late = 0;
                    let rest = 0;

                    Object.values(dayData).forEach(shift => {
                        const shiftInfo = SHIFT_MAP[shift];
                        if (shiftInfo) {
                            if (shiftInfo.type === 'early') early++;
                            else if (shiftInfo.type === 'late') late++;
                            else if (shiftInfo.type === 'rest') rest++;
                        }
                    });

                    const manpowerValid = checkManpowerRule(dateString, { early, late, rest });

                    acc[dateString] = { early, late, rest, manpowerValid };
                    return acc;
                }, {});
            }, [allDates, scheduleForDisplay]);

            // 計算每日班別規則驗證
            const shiftRuleViolations = useMemo(() => {
                const violations = {};
                for (let i = 0; i < allDates.length - 1; i++) {
                    const currentDay = allDates[i].dateString;
                    const nextDay = allDates[i + 1].dateString;

                    const currentDayData = scheduleForDisplay[currentDay] || {};
                    const nextDayData = scheduleForDisplay[nextDay] || {};
                    
                    WORKERS.forEach(worker => {
                        const currentShift = currentDayData[worker];
                        const nextShift = nextDayData[worker];

                        if (currentShift && nextShift && !checkShiftRule(currentShift, nextShift)) {
                            // 記錄違規
                            if (!violations[currentDay]) violations[currentDay] = {};
                            violations[currentDay][worker] = true;
                        }
                    });
                }
                return violations;
            }, [allDates, scheduleForDisplay]);
            
            // 找出今天
            const todayString = useMemo(() => formatDate(new Date()), []);
            
            // 總工時計算
            const totalHoursSummary = useMemo(() => {
                const summary = WORKERS.reduce((acc, worker) => {
                    acc[worker] = { totalHours: 0, earlyShifts: 0, lateShifts: 0, restDays: 0, cycleHours: 0 };
                    return acc;
                }, {});

                // 找出當前月份的索引範圍
                const currentMonthDates = allDates.filter(d => d.isCurrentMonth);
                const firstDayOfMonth = currentMonthDates[0]?.dateString;
                const lastDayOfMonth = currentMonthDates[currentMonthDates.length - 1]?.dateString;

                // 總結當月工時
                allDates.filter(d => d.isCurrentMonth).forEach(({ dateString }) => {
                    const dayData = scheduleForDisplay[dateString] || {};
                    WORKERS.forEach(worker => {
                        const shift = dayData[worker];
                        const shiftInfo = SHIFT_MAP[shift];
                        if (shiftInfo) {
                            summary[worker].totalHours += shiftInfo.hours;
                            if (shiftInfo.type === 'early') summary[worker].earlyShifts++;
                            else if (shiftInfo.type === 'late') summary[worker].lateShifts++;
                            else if (shiftInfo.type === 'rest') summary[worker].restDays++;
                        }
                    });
                });
                
                // 計算變形工時週期工時 (從本月 1 號開始)
                WORKERS.forEach(worker => {
                    let cycleHours = 0;
                    // 假設週期結算日是 1/18, 2/15, 3/15
                    let cycleStart = new Date(currentYear, currentMonth - 1, 1);
                    
                    // 找到上一個週期結算日，從它隔天開始算
                    for(const end of CYCLE_END_DATES){
                         const endDate = new Date(end);
                         if(endDate < cycleStart){
                            cycleStart = new Date(endDate);
                            cycleStart.setDate(endDate.getDate() + 1); // 結算日隔天
                         }
                    }
                    
                    // 檢查從週期開始日到本月底的工時
                    allDates.forEach(({ date, dateString }) => {
                        // 確保 dateString 屬於當前顯示的月份
                        if(date >= cycleStart && dateString <= lastDayOfMonth) {
                            const dayData = scheduleForDisplay[dateString] || {};
                            const shift = dayData[worker];
                            const shiftInfo = SHIFT_MAP[shift];
                            if (shiftInfo) {
                                cycleHours += shiftInfo.hours;
                            }
                        }
                    });
                    summary[worker].cycleHours = cycleHours;
                });

                return summary;
            }, [allDates, scheduleForDisplay, currentMonth, currentYear]);


            // ===================================
            // UI Components
            // ===================================

            /**
             * 月份/年份選擇器
             */
            const MonthSelector = () => {
                const years = [2025, 2026, 2027];
                const months = Array.from({ length: 12 }, (_, i) => i + 1);

                const handleViewChange = () => {
                    setCurrentYear(selectedYear);
                    setCurrentMonth(selectedMonth);
                };

                return (
                    <div className="flex items-center space-x-2 text-sm print:hidden">
                        <label htmlFor="year-select" className="text-gray-700">年份:</label>
                        <select
                            id="year-select"
                            className="p-1 border border-gray-300 rounded"
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                        >
                            {years.map(y => (
                                <option key={y} value={y}>{y}</option>
                            ))}
                        </select>
                        <label htmlFor="month-select" className="text-gray-700">月份:</label>
                        <select
                            id="month-select"
                            className="p-1 border border-gray-300 rounded"
                            value={selectedMonth}
                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                        >
                            {months.map(m => (
                                <option key={m} value={m}>{m} 月</option>
                            ))}
                        </select>
                        <button
                            className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-150 shadow-md"
                            onClick={handleViewChange}
                        >
                            切換月份
                        </button>
                    </div>
                );
            };

            /**
             * 顯示當前用戶 ID
             */
            const UserDisplay = () => {
                if (!userId) return <span className="text-xs text-gray-500">認證中...</span>;
                return (
                    <div className="text-xs text-gray-700 p-2 bg-white rounded-lg shadow-sm">
                        <span className="font-semibold">當前用戶 ID:</span> 
                        <span className="ml-2 break-all text-blue-600 font-mono text-[10px]">{userId}</span>
                    </div>
                );
            };

            /**
             * 班別輸入/選擇元件
             */
            const ShiftInput = ({ dateString, worker, currentShift, onShiftChange, isRuleViolated, isManpowerValid, isDraft }) => {
                const date = new Date(dateString);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isCycleEnd = CYCLE_END_DATES.includes(dateString);
                const isToday = dateString === todayString;
                
                // 檢查是否為 H/R/O 休息類班別
                const isRestShift = SHIFT_MAP[currentShift]?.type === 'rest';

                const cellClasses = `
                    p-0.5 w-10 h-10 border border-gray-300 relative transition-all duration-100
                    ${isDraft ? 'bg-blue-100' : 'hover:bg-gray-100'}
                    ${isWeekend ? 'bg-gray-50 print:bg-gray-100' : 'bg-white'}
                    ${isToday ? 'border-2 border-indigo-500' : ''}
                    ${isCycleEnd ? 'border-r-yellow-400 border-r-2' : ''}
                `;

                const textClasses = `text-[10px] font-semibold block w-full h-full leading-8 text-center
                    ${isRestShift ? 'text-red-600 print:text-red-600 font-bold' : SHIFT_MAP[currentShift]?.color || 'text-gray-900'}
                `;

                // 人力規則違規標示 (僅在非休息日標示)
                const manpowerIndicator = isManpowerValid || isRestShift ? '' : 'absolute top-0 right-0 h-1.5 w-1.5 bg-red-500 rounded-full animate-pulse';

                // 班別規則違規標示 (邊框)
                const ruleViolationClasses = isRuleViolated ? 'border-2 border-red-500' : '';

                return (
                    <td className={`${cellClasses} ${ruleViolationClasses}`}>
                        <div className={manpowerIndicator}></div>
                        <select
                            value={currentShift || ''}
                            onChange={(e) => onShiftChange(dateString, worker, e.target.value)}
                            className={`${textClasses} appearance-none bg-transparent cursor-pointer focus:outline-none`}
                            title={`${dateString} ${worker}：${currentShift || '未排班'}`}
                        >
                            <option value="">--</option>
                            {SHIFTS.map(shift => (
                                <option 
                                    key={shift} 
                                    value={shift}
                                    className={SHIFT_MAP[shift]?.color || 'text-gray-900'}
                                >
                                    {shift.replace('-Holiday', '').replace('-Rest', '').replace('-Other', '')}
                                </option>
                            ))}
                        </select>
                    </td>
                );
            };
            
            /**
             * 主排班表
             */
            const ShiftTable = () => {
                const currentData = getCurrentData();

                return (
                    <div className="overflow-x-auto rounded-lg shadow-xl bg-white p-4">
                        <h2 className="text-xl font-bold mb-4 text-gray-800 print:text-base print:mb-2">
                            {currentYear} 年 {currentMonth} 月 排班表
                        </h2>
                        <table className="min-w-full divide-y divide-gray-200 border-collapse">
                            {/* 表頭：日期和星期 */}
                            <thead>
                                <tr>
                                    <th className="sticky left-0 bg-gray-200 p-2 text-xs font-semibold text-gray-600 border border-gray-300 w-16 print:w-10 print:p-1 print:text-xs print:bg-gray-100">
                                        員工 \ 日期
                                    </th>
                                    {allDates.map(({ date, isCurrentMonth, dateString }) => {
                                        const dayOfWeek = date.getDay(); // 0 = Sunday
                                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                        const isCycleEnd = CYCLE_END_DATES.includes(dateString);
                                        const isToday = dateString === todayString;

                                        const dayClasses = `
                                            p-2 text-center text-xs font-medium w-10
                                            ${isCurrentMonth ? 'text-gray-900' : 'text-gray-400'}
                                            ${isWeekend ? 'bg-red-100 print:bg-gray-200' : 'bg-gray-100 print:bg-gray-100'}
                                            ${isToday ? 'border-2 border-indigo-500' : 'border border-gray-300'}
                                            ${isCycleEnd ? 'border-r-yellow-400 border-r-2 bg-yellow-100 print:bg-yellow-100' : ''}
                                        `;
                                        return (
                                            <th key={dateString} className={dayClasses} title={dateString}>
                                                <div className="flex flex-col gap-0.5">
                                                    <span>{date.getDate()}</span>
                                                    <span className="font-normal text-xs">{DAY_NAMES[dayOfWeek]}</span>
                                                </div>
                                            </th>
                                        );
                                    })}
                                </tr>
                            </thead>
                            {/* 表身：員工排班 */}
                            <tbody className="divide-y divide-gray-200">
                                {WORKERS.map(worker => (
                                    <tr key={worker}>
                                        <td className="sticky left-0 bg-gray-200 p-2 text-sm font-semibold text-gray-700 border border-gray-300 w-16 text-center print:w-10 print:p-1 print:text-xs print:bg-gray-100">
                                            {worker}
                                        </td>
                                        {allDates.map(({ dateString }, index) => {
                                            const currentShift = currentData[dateString]?.[worker] || '';
                                            const nextDateString = allDates[index + 1]?.dateString;
                                            
                                            // 檢查隔日規則 (B06 -> A07)
                                            let isRuleViolated = false;
                                            if (nextDateString) {
                                                const nextShift = currentData[nextDateString]?.[worker] || '';
                                                if (!checkShiftRule(currentShift, nextShift)) {
                                                    isRuleViolated = true;
                                                }
                                            }

                                            return (
                                                <ShiftInput
                                                    key={dateString}
                                                    dateString={dateString}
                                                    worker={worker}
                                                    currentShift={currentShift}
                                                    onShiftChange={handleShiftChange}
                                                    isRuleViolated={isRuleViolated}
                                                    isManpowerValid={dailySummaries[dateString]?.manpowerValid}
                                                    isDraft={isDraftMode && !!draftData[dateString]?.[worker] && (draftData[dateString]?.[worker] !== scheduleData[dateString]?.[worker])} // 僅在預排模式下，且與正式資料不同時標記
                                                />
                                            );
                                        })}
                                    </tr>
                                ))}
                                {/* 總計列：顯示每日早晚班人數 */}
                                <tr>
                                    <td className="sticky left-0 bg-gray-300 p-2 text-xs font-semibold text-gray-700 border border-gray-300 w-16 text-center print:w-10 print:p-1 print:text-xs print:bg-gray-200">
                                        總計 (早/晚)
                                    </td>
                                    {allDates.map(({ dateString }) => {
                                        const summary = dailySummaries[dateString];
                                        const a = summary?.early || 0;
                                        const b = summary?.late || 0;
                                        const isValid = summary?.manpowerValid;
                                        const isCycleEnd = CYCLE_END_DATES.includes(dateString);

                                        return (
                                            <td 
                                                key={dateString} 
                                                className={`p-0.5 text-center w-10 h-10 bg-gray-200 border-b border-gray-300 text-[10px] ${isCycleEnd ? 'border-r-yellow-400 border-r-2' : ''}`}
                                            >
                                                <div className={`flex flex-col gap-0.5 items-center ${isValid ? 'text-slate-500' : 'text-red-600 font-bold'}`}>
                                                    <span>早:{a}</span>
                                                    <span>晚:{b}</span>
                                                </div>
                                            </td>
                                        );
                                    })}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                );
            }

            /**
             * 底部總結面板
             */
            const SummaryPanel = () => {
                return (
                    <div className="mt-8 p-4 bg-white rounded-lg shadow-xl print:hidden">
                        <h3 className="text-lg font-bold mb-3 text-gray-700">總結與規則檢查</h3>
                        
                        {/* 模式切換與儲存 */}
                        <div className="flex justify-between items-center mb-4 border-b pb-4">
                            <div className="flex items-center space-x-4">
                                <span className="font-semibold text-gray-600">排班模式:</span>
                                <div className="flex items-center">
                                    <label className="inline-flex items-center cursor-pointer">
                                        <input
                                            type="checkbox"
                                            className="sr-only peer"
                                            checked={isDraftMode}
                                            onChange={() => setIsDraftMode(!isDraftMode)}
                                        />
                                        <div className="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:border-gray-300 after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                        <span className={`ms-3 text-sm font-medium ${isDraftMode ? 'text-blue-600 font-bold' : 'text-gray-900'}`}>
                                            {isDraftMode ? '預排模式 (淺藍底色)' : '正式模式'}
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <div className="flex items-center space-x-3">
                                <button
                                    className={`px-4 py-2 text-white font-bold rounded-lg transition duration-200 shadow-md 
                                        ${(isDraftMode || isSaving || !isAuthReady) ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}
                                    `}
                                    onClick={() => saveSchedule(getCurrentData())}
                                    disabled={isDraftMode || isSaving || !isAuthReady}
                                >
                                    {isSaving ? '儲存中...' : '儲存正式排班表'}
                                </button>
                                {saveMessage && (
                                    <span className={`text-sm font-semibold ${saveMessage.includes('成功') ? 'text-green-600' : 'text-red-600'}`}>
                                        {saveMessage}
                                    </span>
                                )}
                            </div>
                        </div>

                        {/* 員工總結 */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            {WORKERS.map(worker => (
                                <div key={worker} className="p-3 border rounded-lg shadow-sm bg-gray-50">
                                    <p className="font-bold text-md text-gray-800 mb-1">{worker} 的總結 ({currentMonth} 月)</p>
                                    <p className="text-sm text-gray-600">
                                        當月總工時: <span className="font-mono text-blue-600 font-bold">{totalHoursSummary[worker].totalHours}</span> 小時
                                    </p>
                                    <p className="text-xs text-gray-500">
                                        (早班: {totalHoursSummary[worker].earlyShifts} 次 / 晚班: {totalHoursSummary[worker].lateShifts} 次 / 休息: {totalHoursSummary[worker].restDays} 次)
                                    </p>
                                    <p className="text-sm text-gray-600 mt-1">
                                        變形工時週期工時: <span className="font-mono text-indigo-600 font-bold">{totalHoursSummary[worker].cycleHours}</span> 小時
                                    </p>
                                    <p className="text-xs text-gray-500">
                                        (從本週期開始日計算至本月底)
                                    </p>
                                </div>
                            ))}
                        </div>
                        
                        {/* 規則違規總結 */}
                        <div className="mt-4 border-t pt-4">
                            <h4 className="text-base font-bold mb-2 text-red-600">⚠ 規則違規一覽 (請檢查紅色標示)</h4>
                            <ul className="text-sm text-gray-700 space-y-1">
                                <li>
                                    <span className="font-semibold">班別規則 (B06 隔天不能接非 A07/休息):</span>
                                    {Object.keys(shiftRuleViolations).length > 0 ? (
                                        <span className="ml-2 text-red-600 font-bold">
                                            有 {Object.keys(shiftRuleViolations).length} 個日期有違規。
                                        </span>
                                    ) : (
                                        <span className="ml-2 text-green-600">✔ 全部符合規則</span>
                                    )}
                                </li>
                                <li>
                                    <span className="font-semibold">人力規則 (假日/特殊日期人力):</span>
                                    {Object.values(dailySummaries).some(s => !s.manpowerValid) ? (
                                        <span className="ml-2 text-red-600 font-bold">
                                            有日期的人力配置不符合要求 (請看總計列的 <span className="text-red-600">紅色字體</span>)。
                                        </span>
                                    ) : (
                                        <span className="ml-2 text-green-600">✔ 全部符合要求</span>
                                    )}
                                </li>
                            </ul>
                        </div>
                    </div>
                );
            }

            // 主渲染區塊
            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto">
                    <div className="flex flex-wrap justify-between items-start mb-6 gap-4">
                        <h1 className="text-3xl font-extrabold text-gray-900 print:text-xl print:font-bold print:block print:w-full">
                            2026 線上排班系統
                        </h1>
                        <MonthSelector />
                        <UserDisplay />
                    </div>

                    {auth === null || !isAuthReady ? (
                        <div className="text-center p-10 bg-white rounded-lg shadow-md">
                            <p className="text-lg text-gray-600">系統初始化中，請稍候...</p>
                        </div>
                    ) : (
                        <>
                            <ShiftTable />
                            <SummaryPanel />
                            
                            <div className="mt-8 text-xs text-gray-500 space-y-1 print:hidden">
                                <h4 className="font-semibold text-gray-700 mb-1">排班表標示說明：</h4>
                                <p>* 班別規則：<span className="text-red-600 font-bold border border-red-500 px-1 rounded">紅色邊框</span> 標示該員工當天班別違反「B06隔天僅能排A07或休息」的規則。</p>
                                <p>* 人力規則：總計列的 <span className="text-red-600 font-bold">紅色字體</span> 標示當天早/晚班人數不符合「假日/特殊日期人力」規則。</p>
                                <p>* 人力警示：班別儲存格右上角 <span className="inline-block h-1.5 w-1.5 bg-red-500 rounded-full">紅色圓點</span> 標示當天的人力總數不符合要求。</p>
                                <p>* 標示說明：<span className="text-red-600 font-bold">紅色字體</span> 為 H/R/O 休息類班別；<span className="bg-blue-100 px-1 rounded">淺藍底色</span> 為預排模式下與正式資料不同的班別。</p>
                                <p>* 週期標示：<span className="border-r-yellow-400 border-r-2 px-1 rounded bg-yellow-100">黃色粗線與底色</span> 標示變形工時的結算日 (如 1/18, 2/15...)。</p>
                                <p>* 今天標示：<span className="border-2 border-indigo-500 px-1 rounded">靛藍色粗線</span> 標示今天的日期。</p>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>