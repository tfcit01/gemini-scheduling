<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 兼職人員排班系統 (PT)</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .modal-overlay { display: none !important; }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            doc,
            onSnapshot,
            setDoc,
            deleteDoc,
            updateDoc
        };

        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- 主程式 -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icons ---
        const Icons = {
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            CalendarDays: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            ShieldAlert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        // --- Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDw0xUFVuiK0hqnJuJUDFV_lS-Cf8IUtFc",
            authDomain: "pt-schedule-1ad44.firebaseapp.com",
            projectId: "pt-schedule-1ad44",
            storageBucket: "pt-schedule-1ad44.firebasestorage.app",
            messagingSenderId: "753510421334",
            appId: "1:753510421334:web:b64c450123ace9229ffcf7",
            measurementId: "G-EFM9Y7B90W"
        };

        const APP_ID = "pt-schedule-1ad44";
        const COLLECTION_NAME = "pt_roster_2026"; 
        const SETTINGS_DOC = "settings_2026_v2"; 
        const ADMIN_PWD = "8980";

        const DEFAULT_STAFF = ["王羿涵 (早班)", "謝昕穎 (晚班)", "陳怡杉 (假日班)"];

        const SHIFTS = {
            MORNING: { id: 'M', label: '早班', time: '09:00-15:00', color: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
            EVENING: { id: 'E', label: '晚班', time: '16:30-22:00', color: 'bg-indigo-100 text-indigo-800 border-indigo-200' },
            HOLIDAY: { id: 'H', label: '假日班', time: '10:00-22:00', color: 'bg-rose-100 text-rose-800 border-rose-200' }
        };

        const formatDate = (year, month, day) => {
            const m = String(month + 1).padStart(2, '0');
            const d = String(day).padStart(2, '0');
            return `${year}-${m}-${d}`;
        };

        const isWeekend = (dateStr) => {
            const day = new Date(dateStr).getDay();
            return day === 0 || day === 6;
        };
        const HOLIDAYS_2026 = ['2026-01-01', '2026-02-14', '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22','2026-02-27', '2026-02-28', '2026-03-01','2026-04-03', '2026-04-04', '2026-04-05', '2026-04-06','2026-05-01', '2026-05-02', '2026-05-03','2026-06-19', '2026-06-20', '2026-06-21','2026-09-25', '2026-09-26', '2026-09-27', '2026-09-28','2026-10-09', '2026-10-10', '2026-10-11','2026-10-24', '2026-10-25', '2026-10-26','2026-12-25', '2026-12-26', '2026-12-27'];
        const isHoliday = (dateStr) => HOLIDAYS_2026.includes(dateStr) || isWeekend(dateStr);

        const getDefaultShift = (dateStr, staffIndex) => {
            const isHol = isHoliday(dateStr);
            if (staffIndex === 0) return isHol ? '' : 'M';
            else if (staffIndex === 1) return isHol ? '' : 'E';
            else if (staffIndex === 2) return isHol ? 'H' : '';
            return '';
        };

        // --- Components ---

        const EditShiftModal = ({ isOpen, onClose, dateStr, staffIndex, currentData, staffNames, onSave, defaultShiftId }) => {
            if (!isOpen) return null;

            const [shiftId, setShiftId] = useState('');
            const [isLeave, setIsLeave] = useState(false);
            const [subName, setSubName] = useState('');
            const [isFullTimeSub, setIsFullTimeSub] = useState(false);
            const [markAsEmergency, setMarkAsEmergency] = useState(false);
            const [isLate, setIsLate] = useState(false);
            const [lateNote, setLateNote] = useState('');
            const [showPwdPrompt, setShowPwdPrompt] = useState(false);
            const [pwdInput, setPwdInput] = useState('');

            useEffect(() => {
                if (isOpen) {
                    const currentShift = currentData?.shiftId ?? defaultShiftId;
                    const currentLeaveType = currentData?.leaveType || 'NONE';
                    setShiftId(currentShift);
                    setIsLeave(currentLeaveType !== 'NONE');
                    setMarkAsEmergency(currentLeaveType === 'EMERGENCY');
                    setSubName(currentData?.subName || '');
                    setIsFullTimeSub(currentData?.isFullTimeSub || false);
                    setIsLate(currentData?.isLate || false);
                    setLateNote(currentData?.lateNote || '');
                }
            }, [isOpen]); 

            const handleSave = () => {
                let finalLeaveType = 'NONE';
                if (isLeave) finalLeaveType = markAsEmergency ? 'EMERGENCY' : 'PLANNED';
                onSave({
                    shiftId,
                    leaveType: finalLeaveType,
                    subName: isLeave ? subName : '', 
                    isFullTimeSub: isLeave ? isFullTimeSub : false,
                    isLate,
                    lateNote: isLate ? lateNote : ''
                });
                onClose();
            };

            const toggleLate = () => {
                if (!isLate) setShowPwdPrompt(true);
                else setIsLate(false);
            };

            const verifyPwd = () => {
                if (pwdInput === ADMIN_PWD) {
                    setIsLate(true);
                    setShowPwdPrompt(false);
                    setPwdInput('');
                } else {
                    alert('密碼錯誤！');
                }
            };

            const dateObj = new Date(dateStr);
            const dateLabel = `${dateObj.getMonth()+1}/${dateObj.getDate()} (週${['日','一','二','三','四','五','六'][dateObj.getDay()]})`;
            
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 modal-overlay backdrop-blur-sm fade-in p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6 border-b pb-3">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">{staffNames[staffIndex]}</h3>
                                <p className="text-sm text-slate-500">{dateLabel} 設定</p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition"><Icons.X size={24} /></button>
                        </div>

                        <div className="space-y-6 overflow-y-auto pr-1">
                            {/* 班別調整 */}
                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">班別調整</label>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => {setShiftId(''); setIsLeave(false);}} className={`p-2 rounded-lg border-2 text-xs font-medium ${shiftId === '' ? 'border-slate-500 bg-slate-100' : 'border-slate-100'}`}>休假</button>
                                    <button onClick={() => setShiftId('M')} className={`p-2 rounded-lg border-2 text-xs font-medium ${shiftId === 'M' ? 'border-yellow-500 bg-yellow-50' : 'border-slate-100'}`}>早班</button>
                                    <button onClick={() => setShiftId('E')} className={`p-2 rounded-lg border-2 text-xs font-medium ${shiftId === 'E' ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100'}`}>晚班</button>
                                    <button onClick={() => setShiftId('H')} className={`p-2 rounded-lg border-2 text-xs font-medium ${shiftId === 'H' ? 'border-rose-500 bg-rose-50' : 'border-slate-100'}`}>假日班</button>
                                </div>
                            </div>

                            {/* 出勤與遲到 */}
                            {shiftId && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-slate-700 mb-2">出勤狀況</label>
                                        <div className="flex gap-2 p-1 bg-slate-100 rounded-lg">
                                            <button onClick={() => setIsLeave(false)} className={`flex-1 py-1.5 rounded-md text-xs font-medium ${!isLeave ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>正常出勤</button>
                                            <button onClick={() => setIsLeave(true)} className={`flex-1 py-1.5 rounded-md text-xs font-medium ${isLeave ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>請假</button>
                                        </div>
                                    </div>

                                    {!isLeave && (
                                        <div className={`p-3 rounded-lg border transition-all ${isLate ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-100'}`}>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <Icons.Clock size={16} className={isLate ? 'text-amber-600' : 'text-slate-400'} />
                                                    <span className={`text-sm font-bold ${isLate ? 'text-amber-800' : 'text-slate-600'}`}>人員遲到</span>
                                                </div>
                                                <button 
                                                    onClick={toggleLate}
                                                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${isLate ? 'bg-amber-600 text-white' : 'bg-slate-200 text-slate-500'}`}
                                                >
                                                    {isLate ? '已標記' : '標記遲到'}
                                                </button>
                                            </div>
                                            {isLate && (
                                                <input 
                                                    type="text" 
                                                    value={lateNote} 
                                                    onChange={(e) => setLateNote(e.target.value)}
                                                    placeholder="註記遲到資訊 (如: 遲到10分鐘)"
                                                    className="w-full mt-2 p-2 text-xs border border-amber-300 rounded bg-white outline-none focus:ring-1 focus:ring-amber-500"
                                                />
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* 代班安排 */}
                            {shiftId && isLeave && (
                                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 space-y-3">
                                    <p className="text-xs font-bold text-orange-800 flex items-center gap-1"><Icons.Users size={14}/> 代班安排</p>
                                    <select 
                                        value={!isFullTimeSub ? subName : ''}
                                        onChange={(e) => {setSubName(e.target.value); setIsFullTimeSub(false);}}
                                        className="w-full p-2 border border-slate-200 rounded text-xs outline-none"
                                    >
                                        <option value="">-- 由其他 PT 代班 --</option>
                                        {staffNames.map((name, idx) => idx !== staffIndex ? <option key={name} value={name}>{name.split(' ')[0]}</option> : null)}
                                    </select>
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={isFullTimeSub} onChange={(e) => {setIsFullTimeSub(e.target.checked); if(e.target.checked) setSubName('');}} className="rounded text-orange-600"/>
                                        <span className="text-xs text-slate-600">由正職/其他人員代班</span>
                                    </div>
                                    {isFullTimeSub && <input type="text" value={subName} onChange={(e) => setSubName(e.target.value)} placeholder="代班人姓名" className="w-full p-2 border border-slate-200 rounded text-xs outline-none"/>}
                                </div>
                            )}
                        </div>

                        <div className="mt-6 flex justify-end gap-2 border-t pt-4">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 text-sm">取消</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-lg">確認儲存</button>
                        </div>

                        {/* 密碼驗證 */}
                        {showPwdPrompt && (
                            <div className="absolute inset-0 z-50 bg-white/95 flex items-center justify-center p-6 flex-col">
                                <Icons.Lock size={40} className="text-slate-400 mb-4" />
                                <h4 className="font-bold text-slate-800 mb-2">管理者驗證</h4>
                                <p className="text-xs text-slate-500 mb-6">請輸入管理密碼以標記遲到記錄</p>
                                <input 
                                    type="password" 
                                    autoFocus
                                    value={pwdInput}
                                    onChange={(e) => setPwdInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && verifyPwd()}
                                    className="w-full max-w-[200px] p-3 border-2 border-slate-200 rounded-xl text-center text-lg tracking-widest outline-none focus:border-slate-900 transition-all"
                                />
                                <div className="flex gap-4 mt-8">
                                    <button onClick={() => {setShowPwdPrompt(false); setPwdInput('');}} className="text-sm text-slate-500">取消</button>
                                    <button onClick={verifyPwd} className="px-8 py-2 bg-slate-900 text-white rounded-lg text-sm font-bold">驗證</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StatsDashboard = ({ data, staffNames, currentDate }) => {
            const stats = useMemo(() => {
                if (!staffNames.length) return [];
                const res = staffNames.map(name => ({ name, expectedDays: 0, actualDays: 0, leaveDays: 0, emergencyCount: 0, subCount: 0, lateCount: 0 }));
                const currentMonthIdx = currentDate.getMonth();
                const startYear = new Date(currentDate.getFullYear(), 0, 1);
                const endMonth = new Date(currentDate.getFullYear(), currentMonthIdx + 1, 0);

                for (let d = new Date(startYear); d <= endMonth; d.setDate(d.getDate() + 1)) {
                    const dateStr = formatDate(d.getFullYear(), d.getMonth(), d.getDate());
                    const isMonth = d.getMonth() === currentMonthIdx;
                    staffNames.forEach((_, sIdx) => {
                        const cell = data[`${dateStr}_${sIdx}`];
                        let shiftId = cell?.shiftId ?? getDefaultShift(dateStr, sIdx);
                        if (shiftId) {
                            res[sIdx].expectedDays++;
                            if (cell?.leaveType === 'NONE' || !cell?.leaveType) res[sIdx].actualDays++;
                            else {
                                res[sIdx].leaveDays++;
                                if (cell?.leaveType === 'EMERGENCY' && isMonth) res[sIdx].emergencyCount++;
                            }
                        }
                        if (isMonth && cell?.isLate) res[sIdx].lateCount++;
                        if (cell?.subName) {
                            const subIdx = staffNames.findIndex(n => n.startsWith(cell.subName.split(' ')[0]));
                            if (subIdx !== -1) res[subIdx].subCount++;
                        }
                    });
                }
                return res;
            }, [data, staffNames, currentDate]);

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 print:hidden">
                    {stats.map((s, idx) => (
                        <div key={idx} className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 relative overflow-hidden">
                            <div className={`absolute top-0 left-0 w-1 h-full ${['bg-yellow-400', 'bg-indigo-400', 'bg-rose-400'][idx % 3]}`}></div>
                            <div className="flex justify-between items-start mb-2">
                                <h4 className="font-bold text-slate-800">{s.name.split(' ')[0]} <span className="text-[10px] font-normal text-slate-400 ml-1">PT</span></h4>
                                <div className="text-right">
                                    <p className="text-[10px] text-slate-400">本月遲到</p>
                                    <p className={`text-lg font-black ${s.lateCount > 0 ? 'text-amber-600' : 'text-slate-300'}`}>{s.lateCount} <span className="text-[10px]">次</span></p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2 mt-4 text-[11px] pt-3 border-t">
                                <div>
                                    <p className="text-slate-400">實到/應到 (累計)</p>
                                    <p className="font-bold">{s.actualDays}/{s.expectedDays} 天</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-slate-400">代班貢獻</p>
                                    <p className="font-bold text-emerald-600">+{s.subCount} 次</p>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
            const [scheduleData, setScheduleData] = useState({});
            const [staffNames, setStaffNames] = useState(DEFAULT_STAFF);
            const [isLoading, setIsLoading] = useState(true);
            const [modalOpen, setModalOpen] = useState(false);
            const [editingCell, setEditingCell] = useState(null); 

            useEffect(() => {
                const init = async () => {
                    try {
                        let attempts = 0;
                        while(!window.firebaseModules && attempts < 20) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, signInWithCustomToken } = window.firebaseModules;
                        const app = initializeApp(FIREBASE_CONFIG);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        setFb({ auth, db });
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                        onAuthStateChanged(auth, (u) => { setUser(u); if(u) setIsLoading(false); });
                    } catch(e) { console.error(e); setIsLoading(false); }
                };
                init();
            }, []);

            useEffect(() => {
                if(!user || !fb) return;
                const { collection, onSnapshot, doc } = window.firebaseModules;
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
                const unsubRoster = onSnapshot(collection(fb.db, 'artifacts', currentAppId, 'public', 'data', COLLECTION_NAME), (snap) => {
                    const d = {}; snap.docs.forEach(doc => d[doc.id] = doc.data());
                    setScheduleData(d);
                }, (err) => console.error(err));
                return () => unsubRoster();
            }, [user, fb]);

            const handleSaveShift = async (data) => {
                if(!user || !fb || !editingCell) return;
                const { doc, setDoc, deleteDoc } = window.firebaseModules;
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : APP_ID;
                const ref = doc(fb.db, 'artifacts', currentAppId, 'public', 'data', COLLECTION_NAME, `${editingCell.dateStr}_${editingCell.staffIndex}`);
                const payload = { ...data, date: editingCell.dateStr, staffIndex: editingCell.staffIndex, updatedAt: new Date().toISOString() };
                const defaultVal = getDefaultShift(editingCell.dateStr, editingCell.staffIndex);
                if (data.shiftId === defaultVal && data.leaveType === 'NONE' && !data.subName && !data.isLate) await deleteDoc(ref);
                else await setDoc(ref, payload, { merge: true });
            };

            const changeMonth = (delta) => setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + delta, 1));
            const daysInMonth = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const count = new Date(year, month + 1, 0).getDate(); 
                const d = []; for (let i = 1; i <= count; i++) d.push(formatDate(year, month, i));
                return d;
            }, [currentDate]);

            if(isLoading) return <div className="h-screen flex items-center justify-center text-slate-500">初始化中...</div>;

            return (
                <div className="min-h-screen p-4 md:p-6 w-full mx-auto print:p-0">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200 print:hidden">
                        <div className="flex items-center gap-3">
                            <div className="bg-slate-800 p-2.5 rounded-lg text-white"><Icons.CalendarDays size={24} /></div>
                            <h1 className="text-xl font-bold text-slate-800">PT 人員排班管理系統</h1>
                        </div>
                        <div className="flex items-center gap-4 mt-4 md:mt-0">
                            <div className="flex items-center bg-slate-100 rounded-lg p-1">
                                <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white rounded-md transition"><Icons.ChevronLeft size={20}/></button>
                                <span className="w-32 text-center font-bold text-slate-700">{currentDate.getMonth()+1}月 {currentDate.getFullYear()}</span>
                                <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white rounded-md transition"><Icons.ChevronRight size={20}/></button>
                            </div>
                            <button onClick={() => window.print()} className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium flex items-center gap-2"><Icons.Printer size={18} />列印</button>
                        </div>
                    </div>

                    <StatsDashboard data={scheduleData} staffNames={staffNames} currentDate={currentDate} />

                    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden print:shadow-none print:border">
                        <div className="overflow-x-auto scrollbar-hide">
                            <table className="w-full min-w-[1200px] border-collapse text-sm">
                                <thead>
                                    <tr className="bg-slate-50 border-b border-slate-200">
                                        <th className="sticky left-0 z-20 bg-slate-50 p-2 min-w-[120px] text-left pl-4 font-semibold border-r">人員 / 日期</th>
                                        {daysInMonth.map(dateStr => {
                                            const d = new Date(dateStr);
                                            const isHol = isHoliday(dateStr);
                                            return (
                                                <th key={dateStr} className={`p-2 min-w-[42px] text-center border-r border-slate-100 ${isHol ? 'bg-rose-50' : ''}`}>
                                                    <div className={`font-bold ${isHol ? 'text-rose-600' : 'text-slate-700'}`}>{d.getDate()}</div>
                                                    <div className={`text-[10px] ${isHol ? 'text-rose-400' : 'text-slate-400'}`}>{['日','一','二','三','四','五','六'][d.getDay()]}</div>
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    {staffNames.map((staff, sIdx) => (
                                        <tr key={sIdx} className="hover:bg-slate-50">
                                            <td className="sticky left-0 z-10 bg-white p-4 border-r border-b font-bold text-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                                {staff.split(' ')[0]}
                                            </td>
                                            {daysInMonth.map(dateStr => {
                                                const cell = scheduleData[`${dateStr}_${sIdx}`] || {};
                                                let shiftId = cell.shiftId ?? getDefaultShift(dateStr, sIdx);
                                                const shift = shiftId ? SHIFTS[Object.keys(SHIFTS).find(k => SHIFTS[k].id === shiftId)] : null;
                                                const isLeave = cell.leaveType && cell.leaveType !== 'NONE';

                                                return (
                                                    <td key={dateStr} onClick={() => { setEditingCell({ dateStr, staffIndex: sIdx }); setModalOpen(true); }} className={`border-b border-r border-slate-100 p-0.5 cursor-pointer h-14 relative ${isHoliday(dateStr) ? 'bg-rose-50/20' : ''}`}>
                                                        {shift && (
                                                            <div className={`w-full h-full rounded flex flex-col items-center justify-center text-xs ${shift.color} ${isLeave ? 'opacity-20 grayscale' : ''}`}>
                                                                <span className="font-bold">{shift.label[0]}</span>
                                                            </div>
                                                        )}
                                                        {cell.isLate && !isLeave && (
                                                            <div className="absolute top-0.5 left-0.5 bg-amber-500 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[9px] font-black z-30 shadow-sm" title={cell.lateNote || '遲到註記'}>!</div>
                                                        )}
                                                        {isLeave && !cell.subName && (
                                                            <div className="absolute inset-0 flex items-center justify-center z-10"><span className={`text-[9px] font-bold px-1 rounded bg-white border ${cell.leaveType === 'EMERGENCY' ? 'text-red-500 border-red-200' : 'text-blue-500 border-blue-200'}`}>{cell.leaveType === 'EMERGENCY' ? '臨' : '請'}</span></div>
                                                        )}
                                                        {cell.subName && (
                                                            <div className="absolute inset-0 flex items-center justify-center z-20 px-0.5">
                                                                <div className="bg-slate-800 text-white text-[11px] font-bold py-1 rounded w-full text-center leading-none tracking-tighter truncate px-0.5">
                                                                    {cell.subName.split(' ')[0]}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="mt-6 p-4 bg-amber-50 rounded-xl border border-amber-200 text-xs text-amber-800 space-y-2 print:hidden">
                        <div className="flex gap-4 mb-1">
                            <span className="flex items-center gap-1 font-bold"><span className="w-3 h-3 bg-amber-500 rounded-full flex items-center justify-center text-white text-[8px]">!</span> 遲到標記</span>
                            <span className="flex items-center gap-1"><span className="w-3 h-3 bg-slate-800 rounded"></span> 代班人員</span>
                        </div>
                        <p className="flex items-center gap-1"><Icons.Lock size={12} /> 「標記遲到」功能受管理密碼保護（密碼：8980），非管理者請勿更動。</p>
                        <p className="flex items-center gap-1"><Icons.Edit size={12} /> 點擊排班格可快速切換請假、遲到與代班狀態。</p>
                    </div>

                    {modalOpen && editingCell && (
                        <EditShiftModal 
                            isOpen={modalOpen} onClose={() => setModalOpen(false)}
                            dateStr={editingCell.dateStr} staffIndex={editingCell.staffIndex}
                            staffNames={staffNames} currentData={scheduleData[`${editingCell.dateStr}_${editingCell.staffIndex}`]}
                            defaultShiftId={getDefaultShift(editingCell.dateStr, editingCell.staffIndex)}
                            onSave={handleSaveShift}
                        />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>